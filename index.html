<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>팔레트 품목 뷰어</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- dayjs for dates -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <style>
    .shadow-soft { box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
    @media print {
      .no-print { display: none !important; }
      body { padding: 0; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="no-print sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-gray-100">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="text-xl font-semibold">팔레트 품목 뷰어</div>
      <div id="palletChip" class="ml-auto text-sm text-gray-600"></div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- 안내 -->
    <section id="intro" class="mb-6 p-4 bg-white rounded-2xl shadow-soft">
      <div class="flex flex-col gap-2">
        <h1 class="text-2xl font-bold">팔레트 상세 목록</h1>
        <p class="text-gray-600">QR로 접속하셨다면, URL의 <code>?p=PALLET_ID</code> 값으로 자동 필터링됩니다.</p>
        <div class="text-sm text-gray-500">예: <code>https://yourdomain.com/pallet.html?p=P-2025-09-031</code></div>
      </div>
    </section>

    <!-- 요약 카드 -->
    <section id="summary" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-2xl p-4 shadow-soft">
        <div class="text-sm text-gray-500">팔레트 ID</div>
        <div id="sumPallet" class="text-xl font-semibold">-</div>
      </div>
      <div class="bg-white rounded-2xl p-4 shadow-soft">
        <div class="text-sm text-gray-500">총 품목수(행)</div>
        <div id="sumItems" class="text-xl font-semibold">-</div>
      </div>
      <div class="bg-white rounded-2xl p-4 shadow-soft">
        <div class="text-sm text-gray-500">총 수량</div>
        <div id="sumQty" class="text-xl font-semibold">-</div>
      </div>
    </section>

    <!-- 컨트롤 바 -->
    <section class="no-print bg-white rounded-2xl p-4 shadow-soft mb-6">
      <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-end">
        <div class="flex-1">
          <label class="block text-sm text-gray-600 mb-1">검색(품명/브랜드/SKU)</label>
          <input id="searchInput" type="search" placeholder="예: 생수, LG, SKU1234" class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">카테고리</label>
          <select id="catSelect" class="border rounded-xl px-3 py-2 min-w-[160px]">
            <option value="">전체</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">정렬</label>
          <select id="sortSelect" class="border rounded-xl px-3 py-2 min-w-[160px]">
            <option value="name_asc">품명 ▲</option>
            <option value="name_desc">품명 ▼</option>
            <option value="qty_desc">수량 ▼</option>
            <option value="qty_asc">수량 ▲</option>
            <option value="exp_asc">유통기한 빠른순</option>
            <option value="exp_desc">유통기한 느린순</option>
          </select>
        </div>
        <div class="ml-auto flex gap-2">
          <button id="btnPrint" class="px-4 py-2 rounded-xl bg-gray-800 text-white">인쇄/PDF</button>
          <button id="btnCsv" class="px-4 py-2 rounded-xl bg-blue-600 text-white">CSV 내려받기</button>
        </div>
      </div>
    </section>

    <!-- 표 -->
    <section class="bg-white rounded-2xl shadow-soft overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 text-gray-600">
            <tr>
              <th class="text-left px-4 py-2">이미지</th>
              <th class="text-left px-4 py-2">SKU</th>
              <th class="text-left px-4 py-2">품명</th>
              <th class="text-left px-4 py-2">브랜드</th>
              <th class="text-left px-4 py-2">카테고리</th>
              <th class="text-right px-4 py-2">수량</th>
              <th class="text-left px-4 py-2">유통기한</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="emptyState" class="hidden p-8 text-center text-gray-500">조건에 맞는 결과가 없습니다.</div>
    </section>

    <!-- 페이지네이션 -->
    <div class="no-print flex items-center justify-between gap-3 mt-4">
      <div class="text-sm text-gray-500">페이지 <span id="pageNow">1</span> / <span id="pageTotal">1</span></div>
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-500">페이지당</label>
        <select id="pageSize" class="border rounded-xl px-3 py-1">
          <option>25</option>
          <option selected>50</option>
          <option>100</option>
        </select>
        <button id="prev" class="px-3 py-1 rounded-lg border">이전</button>
        <button id="next" class="px-3 py-1 rounded-lg border">다음</button>
      </div>
    </div>
  </main>

  <script>
    /**************************************
     * 1) 시트 CSV URL 설정
     * - Google 스프레드시트에서: 파일 → 웹에 게시 → 특정 시트 → 형식 CSV
     * - 아래 CSV_URL에 붙여넣기 (예: https://docs.google.com/spreadsheets/d/...../export?format=csv&gid=0)
     **************************************/
    const https://docs.google.com/spreadsheets/d/e/2PACX-1vQMSNX4IbvxwAt6l_itLPqh9wMcTI6Igca_Fy9OfcepvlWbAAbdQTsv5Z-DRbaUTkgR5p_wWpiT6Fif/pub?gid=2034741760&single=true&output=csv = '<<여기에_스프레드시트_CSV_URL을_붙여넣으세요>>';

    /**************************************
     * 2) 컬럼 이름 매핑(첫 행 헤더와 일치해야 함)
     **************************************/
    const COLS = {
      pallet: 'PalletID', // 팔레트 ID
      sku: 'SKU',         // 품목코드
      name: 'Name',       // 품명
      brand: 'Brand',     // 브랜드
      category: 'Category',
      qty: 'Qty',         // 수량 (정수)
      expiry: 'Expiry',   // 유통기한 (YYYY-MM-DD 형식 권장)
      image: 'ImageURL'   // 이미지 URL (선택)
    };

    // URL 파라미터 읽기
    const url = new URL(location.href);
    const palletParam = url.searchParams.get('p') || url.searchParams.get('pallet') || '';

    // 상태
    let rows = [];       // 전체
    let filtered = [];   // 팔레트 필터 후
    let view = [];       // 검색/카테고리/정렬 반영 후

    // DOM 참조
    const $tbody = document.getElementById('tbody');
    const $empty = document.getElementById('emptyState');
    const $sumPallet = document.getElementById('sumPallet');
    const $sumItems = document.getElementById('sumItems');
    const $sumQty = document.getElementById('sumQty');
    const $palletChip = document.getElementById('palletChip');
    const $search = document.getElementById('searchInput');
    const $cat = document.getElementById('catSelect');
    const $sort = document.getElementById('sortSelect');
    const $pageNow = document.getElementById('pageNow');
    const $pageTotal = document.getElementById('pageTotal');
    const $pageSize = document.getElementById('pageSize');

    let page = 1;

    function fmtDate(v){
      if(!v) return '';
      const d = dayjs(v);
      return d.isValid() ? d.format('YYYY-MM-DD') : v;
    }

    function safeInt(v){
      const n = parseInt(String(v).replace(/[^0-9-]/g,''),10);
      return isNaN(n) ? 0 : n;
    }

    function renderSummary(){
      $sumPallet.textContent = palletParam || '-';
      $palletChip.textContent = palletParam ? `Pallet: ${palletParam}` : '';
      $sumItems.textContent = filtered.length.toLocaleString();
      const totalQty = filtered.reduce((a,r)=> a + safeInt(r[COLS.qty]), 0);
      $sumQty.textContent = totalQty.toLocaleString();
    }

    function applyFilters(){
      const q = $search.value.trim().toLowerCase();
      const cat = $cat.value;
      view = filtered.filter(r=>{
        const hitQ = !q || [COLS.name, COLS.brand, COLS.sku].some(c=> String(r[c]||'').toLowerCase().includes(q));
        const hitC = !cat || String(r[COLS.category]||'') === cat;
        return hitQ && hitC;
      });
      // 정렬
      const s = $sort.value;
      const key = (r)=>({
        'name_asc':   String(r[COLS.name]||'').toLowerCase(),
        'name_desc':  String(r[COLS.name]||'').toLowerCase(),
        'qty_desc':   -safeInt(r[COLS.qty]),
        'qty_asc':    safeInt(r[COLS.qty]),
        'exp_asc':    String(r[COLS.expiry]||'')||'zzzz',
        'exp_desc':   String(r[COLS.expiry]||'')||''
      })[s];
      view.sort((a,b)=>{
        if(s === 'name_desc') return key(b) > key(a) ? 1 : -1;
        if(s === 'exp_desc') return key(b) > key(a) ? 1 : -1;
        return key(a) > key(b) ? 1 : -1;
      });
      // 페이지 초기화
      page = 1;
      renderTable();
    }

    function renderCategories(){
      const cats = Array.from(new Set(filtered.map(r=> String(r[COLS.category]||'').trim()).filter(Boolean))).sort();
      $cat.innerHTML = '<option value="">전체</option>' + cats.map(c=>`<option>${c}</option>`).join('');
    }

    function renderTable(){
      const size = parseInt($pageSize.value, 10) || 50;
      const total = Math.max(1, Math.ceil(view.length / size));
      page = Math.min(page, total);
      $pageNow.textContent = page;
      $pageTotal.textContent = total;
      const start = (page-1)*size;
      const slice = view.slice(start, start+size);

      $tbody.innerHTML = slice.map(r=>{
        const img = r[COLS.image] ? `<img src="${r[COLS.image]}" class="w-16 h-16 object-cover rounded-xl border" onerror="this.style.display='none'"/>` : '';
        return `<tr class="border-b last:border-b-0 hover:bg-gray-50">
          <td class="px-4 py-2">${img}</td>
          <td class="px-4 py-2">${r[COLS.sku]||''}</td>
          <td class="px-4 py-2 font-medium">${r[COLS.name]||''}</td>
          <td class="px-4 py-2">${r[COLS.brand]||''}</td>
          <td class="px-4 py-2">${r[COLS.category]||''}</td>
          <td class="px-4 py-2 text-right">${safeInt(r[COLS.qty]).toLocaleString()}</td>
          <td class="px-4 py-2">${fmtDate(r[COLS.expiry])}</td>
        </tr>`;
      }).join('');

      $empty.classList.toggle('hidden', view.length !== 0);
    }

    function downloadCsv(){
      if(view.length === 0) return;
      const headers = Object.values(COLS);
      const rowsCsv = [headers.join(',')].concat(view.map(r=> headers.map(h=>`"${String(r[h]||'').replaceAll('"','""')}"`).join(',')));
      const blob = new Blob(["\uFEFF" + rowsCsv.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${palletParam||'pallet'}-items.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // 이벤트 바인딩
    document.getElementById('prev').onclick = ()=>{ if(page>1){ page--; renderTable(); } };
    document.getElementById('next').onclick = ()=>{ page++; renderTable(); };
    $pageSize.onchange = ()=> renderTable();
    $search.oninput = ()=> applyFilters();
    $cat.onchange = ()=> applyFilters();
    $sort.onchange = ()=> applyFilters();
    document.getElementById('btnPrint').onclick = ()=> window.print();
    document.getElementById('btnCsv').onclick = downloadCsv;

    // 데이터 로드
    function load(){
      if(!CSV_URL || CSV_URL.startsWith('<<')){
        alert('CSV_URL을 설정하세요. (스프레드시트 → 웹에 게시 → CSV 링크)');
        return;
      }
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (res)=>{
          rows = res.data || [];
          // 팔레트 필터
          filtered = palletParam ? rows.filter(r => String(r[COLS.pallet]||'').trim() === palletParam) : rows;
          renderSummary();
          renderCategories();
          applyFilters();
        },
        error: (err)=>{
          console.error(err);
          alert('데이터를 불러오지 못했습니다. CSV URL과 공개 설정을 확인하세요.');
        }
      });
    }

    window.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>
